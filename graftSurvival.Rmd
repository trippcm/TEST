---
title: "One-Year Kidney Graft Survival Analysis"
author: "Prepared by Christina Saunders on `r format(Sys.time(), '%B %d, %Y')`"
geometry: margin=.75in
output:
  word_document:
    reference_docx: wordRmarkdownTemplate.docx ## template Word Document
    fig_caption: yes
    toc: no
    toc_depth: '2'
editor_options: 
  chunk_output_type: console
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE, results='asis', fig.width=6, fig.height = 4, fig.pos = 'H', fig.align = 'center')
source("oneYrEndpts.R")

```

# Introduction 

A pre-specified secondary endpoint is one-year graft survival of the transplanted kidneys. Kidneys were randomized to pump alone, hypothermia alone, and the combination of pump and hypothermia.

In the event of graft failure, graft survival time is measured from the date of organ transplantation to the date of graft failure. Grafts not known to have failed (i.e., those recorded as functioning or N/A) are censored at the recipients' last follow-up date, up to one year. Survival times beyond one year are considered censored at one year.

# Summaries of One-Year Graft Survival

Of the `r nrow(dat)` kidneys transplanted, there were `r n.graftFailures` kidney graft failures within 1-year, `r n.graftFunctioning` still functioning, and `r n.graftUnknown` within unknown 1-year status. Those functioning and unknown are considerd "alive" for the survival analysis.  The proportion of grafts surviving at one year from each treatment group are presented in the following table.

 <!-- along with the corresponding two-sided 95% confidence intervals  -->
```{r}
fail_tab_print$Summary[which(fail_tab_print$Summary == "frac_Fail")] <- "One-Yr Graft Failure"
fail_tab_print$Summary[which(fail_tab_print$Summary == "frac_NoFail")] <- "One-Yr Graft Survival"
fail_tab_print$Summary[which(fail_tab_print$Summary == "N")] <- "Total N"

fail_tab_print %>% 
      knitr::kable(format = "pandoc",
            booktabs = TRUE,
            linesep = "",
            align = "lrrrr",
            # row.names = TRUE,
            caption = "The number and proportion of graft failures by one-year within each kidney-level randomized treatment arm, and overall. Note that the proportion surviving is a naive estimate of one-year survival, because it does not take into account censoring. Ignoring censoring leads to an overestimate of the overall survival probability, because the censored subjects only contribute information for part of the follow-up time, and then fall out of the risk set, thus pulling down the cumulative probability of survival. The following section shows the Kaplan-Meier estimated probability of one-year survival, which accounts for censoring.")

```

# Kaplan-Meier Estimates

I am editing the text in this section on GitHub to see if it works!

Graft survival at 1 year was estimated by the Kaplan-Meier method, a non-parametric approach to estimate survival times and probabilities that results in a step function, where there is a step down each time a failure occurs. To compare survival between groups we can use the log rank test. The null hypothesis is that there is no difference in survival between the treatment groups or that there is no difference between the treatment groups in the probability of graft failure at any point. The log rank test is a non-parametric test and makes no assumptions about the survival distributions. In essence, the log rank test compares the observed number of graft failures in each treatment group to what would be expected if the null hypothesis were true (i.e., if the survival curves were identical). The log rank statistic is approximately distributed as a chi-square test statistic. The sums of the observed and expected numbers of events are computed for each event time and summed for each comparison group. The log rank statistic has degrees of freedom equal to k-1, where k represents the number of comparison groups. In this case, k=3 randomized kidney-level groups, so the test statistic has 2 degrees of freedom.

The log rank test Chi-square statistic is `r logRankTestChiSqStat` with 2 degrees of freedom. The p-value is `r logRankTestpval`. There is not a statistically significant difference in survival curves between the treatment groups.

```{r, fig.cap = "Kaplan-Meier Plot: One-Year Graft Survival of Kidney Recipients. The table below the plot shows the number of recipients at risk of graft failure at 90 day intervals, and the numbers in parentheses show the cumulative number of graft failures up to that time point.", fig.height = 6, fig.width=6}
## Kaplan-Meier plot with log-rank test pvalue
sfit.plot
# knitr::include_graphics("KMplot.pdf")
```

```{r}
surv1YRsummRes %>% 
      knitr::kable(format = "pandoc",
            booktabs = TRUE,
            linesep = "",
            align = "lcc",
            # row.names = TRUE,
            caption = "Kaplan-Meier estimates of the probability of one-year graft survival for each treatment arm. These estimates correspond to those shown in the Kaplan-Meier plot above, where the horizontal axis is at 365 days.")

```


# Cox regression model 

Treatment groups were formally compared with a Cox proportional hazards model with a cluster term for donor. We present the hazard ratio (HR) for graft failure for hypothermia versus pump alone, hypothermia vs combination, and pump alone vs combination.

There were only 39 events across the 3 treatment arms. The results of the model show that there is a large amount of uncertainty in the estimated hazard ratios. The standard error estimates are twice as large as the estimated regression coefficients (log Hazard Ratios), and the 95% confidence intervals contain a large range of both positive and negative treatment effects, for all of the treatment arms.

```{r}
tidyCoxFitTable %>% 
      knitr::kable(format = "pandoc",
            booktabs = TRUE,
            linesep = "",
            align = "lrrrr",
            # row.names = TRUE,
            caption = "Results of Cox Regression model: One-Year Recipient Graft Failure Adjusted for Kidney-Randomized Treatment Assignment. Robust standard errors were used to account for correlation between kidneys from a single donor. Further covariate adjustment could not be performed because of small or no events within subgroups of covariates.")
```

Adjusted Cox regression could not be performed because of two factors: a low number of failure events, and sparsity of data in subgroups of covariate levels. Specifically, there were only 39 failures, and there should be roughly 10-15 events per covariate included in the model for reliable estimation. After adjusting for the treatment effect, which has 3 levels, there are no remaining degrees of freedom. The following tables illustrate the sparsity of data issue. For instance, there are several OP0-treatment assignment combinations that have zero failures. In the ECD donor type, there were only 7 failures, 0 of which were in the hypo alone group. This prevents reliable estimation of these covariate effects on graft survival. 

```{r}
opoFailTab %>% 
      knitr::kable(format = "pandoc",
            booktabs = TRUE,
            linesep = "",
            align = "llc",
            # row.names = TRUE,
            caption = "Counts of the number of Graft Failures by OPO and Treatment Arm.")

SCDfailTab %>% 
      knitr::kable(format = "pandoc",
            booktabs = TRUE,
            linesep = "",
            align = "llc",
            # row.names = TRUE,
            caption = "SCDs: Counts of the number of Graft Failures by Treatment Arm.")

ECDfailTab  %>% 
      knitr::kable(format = "pandoc",
            booktabs = TRUE,
            linesep = "",
            align = "llc",
            # row.names = TRUE,
            caption = "ECDs: Counts of the number of Graft Failures by Treatment Arm.")
```


<!-- # Analysis Conventions -->
<!-- Note about 1-year graft survival endpoint: The endpoint is censored at 1-year post organ transplantation date. If the transplant occurred in 2018 then we are only reporting the graft status on the 1-YR follow up form (2019). If the graft failed *after* the 1-year follow up form was submitted, then the status will display as functioning even though it may have failed later in 2019 or in 2020 on the 2-YR follow up form. -->

